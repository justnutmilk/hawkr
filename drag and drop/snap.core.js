var d=class{constructor(){this._listeners=new Map}on(e,t){let n=this._listeners.get(e);return n||(n=new Set,this._listeners.set(e,n)),n.add(t),()=>{n.delete(t),n.size===0&&this._listeners.delete(e)}}once(e,t){let n=this.on(e,i=>{n(),t(i)});return n}emit(e,t){let n=this._listeners.get(e);if(n)for(let i of[...n])i(t)}off(e){e?this._listeners.delete(e):this._listeners.clear()}hasListeners(e){let t=this._listeners.get(e);return t!==void 0&&t.size>0}listenerCount(e){return this._listeners.get(e)?.size??0}destroy(){this._listeners.clear()}};var E=class o{constructor(){this._data=new Map}setData(e,t){this._data.set(e,t)}getData(e){return this._data.get(e)}hasType(e){return this._data.has(e)}get types(){return[...this._data.keys()]}clear(){this._data.clear()}clone(){let e=new o;for(let[t,n]of this._data)e.setData(t,n);return e}};var _=class extends d{constructor(){super(...arguments);this._session=null;this._idCounter=0}get session(){return this._session}isDragging(){return this._session!==null&&this._session.phase==="dragging"}getActiveElement(){return this._session?.element??null}getCurrentDropZone(){return this._session?.dropZone??null}startDrag(t,n,i){this._session&&this.cancelDrag();let s=new E;if(i)for(let[r,a]of Object.entries(i))s.setData(r,a);return this._session={id:`drag-${++this._idCounter}`,element:t,origin:{x:n.x,y:n.y},current:{x:n.x,y:n.y},delta:{x:0,y:0},data:s,dropZone:null,phase:"dragging"},this.emit("dragstart",this._session),this._session}updatePosition(t){!this._session||this._session.phase!=="dragging"||(this._session.current.x=t.x,this._session.current.y=t.y,this._session.delta.x=t.x-this._session.origin.x,this._session.delta.y=t.y-this._session.origin.y,this.emit("dragmove",this._session))}setDropTarget(t){if(!this._session)return;let n=this._session.dropZone;n!==t&&(n&&(this._session.dropZone=null,this.emit("dropzoneleave",this._session)),t&&(this._session.dropZone=t,this.emit("dropzoneenter",this._session)))}endDrag(){if(!this._session)return null;let t=this._session;return t.phase="dropping",t.dropZone&&this.emit("drop",t),this.emit("dragend",t),this._session=null,t}cancelDrag(){if(!this._session)return null;let t=this._session;return t.phase="cancelled",t.dropZone=null,this.emit("dragend",t),this._session=null,t}subscribe(t,n){return this.on(t,n)}reset(){this._session&&this.cancelDrag()}destroy(){this.reset(),super.destroy()}};var y=class{constructor(e){this._rafId=null;this._pending=null;this._process=()=>{if(this._rafId=null,this._pending!==null){let e=this._pending;this._pending=null,this._callback(e)}};this._callback=e}queue(e){this._pending=e,this._rafId===null&&(this._rafId=requestAnimationFrame(this._process))}cancel(){this._rafId!==null&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._pending=null}flush(){if(this._pending!==null){let e=this._pending;this.cancel(),this._callback(e)}}get isPending(){return this._rafId!==null}destroy(){this.cancel()}};var D=class{constructor(e,t,n=10,i=100){this._pool=[];this._factory=e,this._reset=t,this._maxSize=i;for(let s=0;s<n;s++)this._pool.push(e())}acquire(){return this._pool.pop()??this._factory()}release(e){this._pool.length<this._maxSize&&(this._reset(e),this._pool.push(e))}clear(){this._pool.length=0}get size(){return this._pool.length}},u=new D(()=>({x:0,y:0}),o=>{o.x=0,o.y=0}),j=new D(()=>({x:0,y:0,width:0,height:0}),o=>{o.x=0,o.y=0,o.width=0,o.height=0});function c(o,e){let t=u.acquire();return t.x=o,t.y=e,t}var x=class extends d{constructor(t){super();this._attached=!1;this._activePointerId=null;this._activeElement=null;this._startPosition=null;this._isDragging=!1;this._delayTimer=null;this._onPointerDown=t=>{if(!t.isPrimary||t.button!==0||this._activePointerId!==null)return;let n=this._findDraggable(t);if(!n||this._options.handleSelector&&!this._findHandle(t,n))return;t.preventDefault(),this._activePointerId=t.pointerId,this._activeElement=n,this._startPosition=c(t.clientX,t.clientY),this._isDragging=!1,t.target.setPointerCapture(t.pointerId);let i=this._getEventTarget();i.addEventListener("pointermove",this._onPointerMove,{passive:!0}),i.addEventListener("pointerup",this._onPointerUp),i.addEventListener("pointercancel",this._onPointerCancel);let s=this._options.delay??0;s>0?this._delayTimer=window.setTimeout(()=>{this._delayTimer=null,this._startDrag(t)},s):(this._options.distance??0)===0&&this._startDrag(t)};this._onPointerMove=t=>{t.pointerId===this._activePointerId&&(this._options.throttle===!1?this._processMove(t):this._moveThrottle.queue(t))};this._processMove=t=>{if(!this._startPosition||!this._activeElement)return;let n=c(t.clientX,t.clientY);if(!this._isDragging){let i=this._options.distance??0;if(i>0){let s=n.x-this._startPosition.x,r=n.y-this._startPosition.y;if(Math.sqrt(s*s+r*r)<i){u.release(n);return}this._clearDelayTimer(),this._startDrag(t)}}if(this._isDragging){let i=c(n.x-this._startPosition.x,n.y-this._startPosition.y);this.emit("pointermove",{position:n,delta:i,pointerId:t.pointerId,originalEvent:t})}else u.release(n)};this._onPointerUp=t=>{t.pointerId===this._activePointerId&&(this._moveThrottle.flush(),this._isDragging&&this.emit("pointerup",{position:c(t.clientX,t.clientY),pointerId:t.pointerId,originalEvent:t}),this._cleanup())};this._onPointerCancel=t=>{t.pointerId===this._activePointerId&&(this._moveThrottle.cancel(),this._isDragging&&this.emit("pointercancel",{position:c(t.clientX,t.clientY),pointerId:t.pointerId,originalEvent:t}),this._cleanup())};this._container=t.container,this._options=t,this._moveThrottle=new y(n=>this._processMove(n))}attach(){if(this._attached)return;this._getEventTarget().addEventListener("pointerdown",this._onPointerDown,{passive:!1}),this._attached=!0}detach(){if(!this._attached)return;this._getEventTarget().removeEventListener("pointerdown",this._onPointerDown),this._cleanup(),this._attached=!1}get isActive(){return this._activePointerId!==null}get isDragging(){return this._isDragging}_getEventTarget(){return this._container instanceof ShadowRoot?this._container.host:this._container}_startDrag(t){this._isDragging||!this._activeElement||!this._startPosition||(this._isDragging=!0,this.emit("pointerdown",{element:this._activeElement,position:{x:this._startPosition.x,y:this._startPosition.y},pointerId:t.pointerId,originalEvent:t}))}_findDraggable(t){let n=t.target,i=t.composedPath();for(let s of i)if(s instanceof HTMLElement){if(s.matches(this._options.draggableSelector))return s;if(s===this._container||s===this._container.host)break}return n.closest?.(this._options.draggableSelector)}_findHandle(t,n){if(!this._options.handleSelector)return n;let s=t.target.closest?.(this._options.handleSelector);return s&&n.contains(s)?s:null}_clearDelayTimer(){this._delayTimer!==null&&(clearTimeout(this._delayTimer),this._delayTimer=null)}_cleanup(){this._clearDelayTimer(),this._moveThrottle.cancel(),this._startPosition&&(u.release(this._startPosition),this._startPosition=null);let t=this._getEventTarget();t.removeEventListener("pointermove",this._onPointerMove),t.removeEventListener("pointerup",this._onPointerUp),t.removeEventListener("pointercancel",this._onPointerCancel),this._activePointerId=null,this._activeElement=null,this._isDragging=!1}destroy(){this.detach(),this._moveThrottle.destroy(),super.destroy()}};var L=class{constructor(){this._cache=new WeakMap;this._dirty=new WeakSet;this._invalidateAll=!1}get(e){if(this._invalidateAll||this._dirty.has(e))return this._update(e);let t=this._cache.get(e);return t||this._update(e)}invalidate(e){this._dirty.add(e)}invalidateAll(){this._invalidateAll=!0}update(e){return this._update(e)}remove(e){this._cache.delete(e)}clearDirty(){this._invalidateAll=!1}_update(e){let t=e.getBoundingClientRect();return this._cache.set(e,t),this._dirty.delete(e),t}},l=new L;function S(o,e,t){return o>=t.left&&o<=t.right&&e>=t.top&&e<=t.bottom}function w(o){return{x:o.left+o.width/2,y:o.top+o.height/2}}var T=class{constructor(e){this._enabled=!1;this._listenerUnsubscribers=[];this._ghost=null;this._ghostOffset={x:0,y:0};this._onPointerDown=e=>{let{element:t,position:n}=e,i=this._getItemData(t)??this._extractDataAttributes(t),s=this._state.startDrag(t,n,i);this._createGhost(t,n),t.classList.add("snap-dragging"),this._options.ghostClass&&t.classList.add(this._options.ghostClass);let r={element:t,position:{x:n.x,y:n.y},data:s.data,cancel:()=>{this._state.cancelDrag(),this._cleanup(t)}};if(this._options.onDragStart?.(r)===!1){this._state.cancelDrag(),this._cleanup(t);return}l.invalidateAll()};this._onPointerMove=e=>{let t=this._state.session;if(!t)return;let{position:n}=e,i=this._getItemAxis(t.element)??this._options.axis??"both";i!=="both"&&(n=this._applyAxisConstraint(n,t.origin,i)),this._options.grid&&(n=this._applyGridSnap(n,this._options.grid)),this._state.updatePosition(n),this._updateGhost(n),this._updateDropZone(n),this._options.onDragMove?.({element:t.element,position:{x:t.current.x,y:t.current.y},delta:{x:t.delta.x,y:t.delta.y},dropZone:t.dropZone})};this._onPointerUp=e=>{if(!this._state.session)return;let n=this._state.endDrag();n&&(this._cleanup(n.element),n.dropZone&&this._options.onDrop?.({element:n.element,dropZone:n.dropZone,position:{x:n.current.x,y:n.current.y},data:n.data}),this._options.onDragEnd?.({element:n.element,position:{x:n.current.x,y:n.current.y},delta:{x:n.delta.x,y:n.delta.y},cancelled:!1}))};this._onPointerCancel=e=>{let t=this._state.session;if(!t)return;let n=t.element;this._state.cancelDrag(),this._cleanup(n),this._options.onDragEnd?.({element:n,position:e.position,delta:{x:0,y:0},cancelled:!0})};this._container=e.container,this._state=e.state,this._options=e.options,this._getDropZones=e.getDropZones,this._getItemData=e.getItemData,this._getItemAxis=e.getItemAxis,this._pointerSensor=new x({container:this._container,draggableSelector:this._options.draggableSelector??"[data-draggable]",handleSelector:this._options.handleSelector,delay:this._options.delay,distance:this._options.distance,throttle:this._options.throttle}),this._setupListeners()}enable(){this._enabled||(this._pointerSensor.attach(),this._enabled=!0)}disable(){this._enabled&&(this._pointerSensor.detach(),this._state.reset(),this._removeGhost(),this._enabled=!1)}get isEnabled(){return this._enabled}updateOptions(e){Object.assign(this._options,e)}_setupListeners(){this._listenerUnsubscribers.push(this._pointerSensor.on("pointerdown",this._onPointerDown),this._pointerSensor.on("pointermove",this._onPointerMove),this._pointerSensor.on("pointerup",this._onPointerUp),this._pointerSensor.on("pointercancel",this._onPointerCancel))}_applyAxisConstraint(e,t,n){return n==="x"?{x:e.x,y:t.y}:n==="y"?{x:t.x,y:e.y}:e}_applyGridSnap(e,t){return{x:Math.round(e.x/t.x)*t.x,y:Math.round(e.y/t.y)*t.y}}_updateDropZone(e){let t=this._getDropZones(),n=null;for(let s of t){let r=l.get(s);if(S(e.x,e.y,r)){n=s;break}}let i=this._state.session;i&&n!==i.dropZone&&(i.dropZone&&this._options.onDropZoneLeave?.({element:i.element,dropZone:i.dropZone}),this._state.setDropTarget(n),n&&this._options.onDropZoneEnter?.({element:i.element,dropZone:n,position:e}))}_createGhost(e,t){let n=e.getBoundingClientRect();this._ghostOffset={x:t.x-n.left,y:t.y-n.top},this._options.renderGhost?this._ghost=this._options.renderGhost(e):(this._ghost=e.cloneNode(!0),this._copyComputedStyles(e,this._ghost)),this._ghost.style.position="fixed",this._ghost.style.left="0",this._ghost.style.top="0",this._ghost.style.width=`${n.width}px`,this._ghost.style.height=`${n.height}px`,this._ghost.style.margin="0",this._ghost.style.pointerEvents="none",this._ghost.style.zIndex="9999",this._ghost.style.opacity="0.8",this._ghost.style.willChange="transform",this._ghost.classList.add("snap-ghost"),this._ghost.style.transform=`translate(${n.left}px, ${n.top}px)`,document.body.appendChild(this._ghost)}_copyComputedStyles(e,t){let n=window.getComputedStyle(e),i=["background","backgroundColor","backgroundImage","border","borderRadius","boxShadow","color","fontSize","fontWeight","fontFamily","textAlign","display","alignItems","justifyContent","flexDirection","flexWrap","padding","gap","margin","width","height","minWidth","minHeight","maxWidth","maxHeight","overflow","textOverflow","whiteSpace","lineHeight","letterSpacing","opacity","visibility","boxSizing"];for(let a of i){let p=n.getPropertyValue(a.replace(/([A-Z])/g,"-$1").toLowerCase());p&&t.style.setProperty(a.replace(/([A-Z])/g,"-$1").toLowerCase(),p)}let s=e.children,r=t.children;for(let a=0;a<s.length;a++)s[a]instanceof HTMLElement&&r[a]instanceof HTMLElement&&this._copyComputedStyles(s[a],r[a])}_updateGhost(e){if(!this._ghost)return;let t=e.x-this._ghostOffset.x,n=e.y-this._ghostOffset.y;this._ghost.style.transform=`translate(${t}px, ${n}px)`}_removeGhost(){this._ghost&&(this._ghost.remove(),this._ghost=null)}_cleanup(e){e.classList.remove("snap-dragging"),this._options.ghostClass&&e.classList.remove(this._options.ghostClass),this._removeGhost()}_extractDataAttributes(e){let t={};for(let i of e.attributes)if(i.name.startsWith("data-drag-")){let s=i.name.slice(10);t[s]=i.value}let n=e.dataset.draggable;return n&&n!==""&&(t.type=n),t}destroy(){this.disable();for(let e of this._listenerUnsubscribers)e();this._listenerUnsubscribers=[],this._pointerSensor.destroy()}};var P=class{constructor(e,t={}){this._isActive=!1;this._element=e,this._options=t}get element(){return this._element}get isActive(){return this._isActive}setOptions(e){Object.assign(this._options,e)}containsPoint(e,t){let n=l.get(this._element);return S(e,t,n)}accepts(e){let{accepts:t}=this._options;if(!t)return!0;if(typeof t=="function")return t(e);for(let i of t)if(e.hasType(i)||e.getData("type")===i)return!0;let n=this._element.dataset.accepts;if(n){let i=n.split(",").map(s=>s.trim());for(let s of i)if(e.hasType(s)||e.getData("type")===s)return!0}return!1}setActive(e){this._isActive!==e&&(this._isActive=e,e?this._element.classList.add("snap-drop-active"):this._element.classList.remove("snap-drop-active"))}getInsertionIndex(e,t,n,i){let s=Array.from(this._element.querySelectorAll(n)).filter(h=>h!==i);if(s.length===0)return 0;let r=l.get(s[0]),a=l.get(s[s.length-1]),p=Math.abs(a.top-r.top)>Math.abs(a.left-r.left);for(let h=0;h<s.length;h++){let g=l.get(s[h]),m=w(g);if(p){if(t<m.y)return h}else if(e<m.x)return h}return s.length}getClosestItem(e,t,n,i){let s=Array.from(this._element.querySelectorAll(n)).filter(f=>f!==i);if(s.length===0)return null;let r=null,a=1/0,p="after",h=l.get(s[0]),g=l.get(s[s.length-1]),m=Math.abs(g.top-h.top)>Math.abs(g.left-h.left);for(let f of s){let A=l.get(f),b=w(A),H=e-b.x,Z=t-b.y,I=Math.sqrt(H*H+Z*Z);I<a&&(a=I,r=f,p=m?t<b.y?"before":"after":e<b.x?"before":"after")}return r?{element:r,position:p}:null}updateBounds(){l.update(this._element)}destroy(){this.setActive(!1),l.remove(this._element)}},v=class{constructor(){this._zones=new Map}register(e,t){let n=this._zones.get(e);return n?(t&&n.setOptions(t),n):(n=new P(e,t),this._zones.set(e,n),n)}unregister(e){let t=this._zones.get(e);t&&(t.destroy(),this._zones.delete(e))}get(e){return this._zones.get(e)}getElements(){return[...this._zones.keys()]}getAll(){return[...this._zones.values()]}findAtPoint(e,t){for(let n of this._zones.values())if(n.containsPoint(e,t))return n;return null}clear(){for(let e of this._zones.values())e.destroy();this._zones.clear()}updateAllBounds(){l.invalidateAll()}destroy(){this.clear()}};var k={draggableSelector:"[data-draggable]",dropZoneSelector:"[data-droppable]",axis:"both",autoRefresh:!1},M=class{constructor(e,t={}){this._imperativeDraggables=new Map;this._imperativeDropZones=new Map;this._plugins=[];this._behaviors=[];this._eventListeners=new Map;this._stateUnsubscribers=[];this._observer=null;this._refreshScheduled=!1;this._destroyed=!1;this._scrollHandler=null;this._resizeHandler=null;this._container=e,this._options={...k,...t},this._wrapCallbacks(),this._state=new _,this._dropZoneManager=new v,this._engine=new T({container:this._container,state:this._state,options:this._options,getDropZones:()=>this._getDropZones(),getItemData:n=>this._getItemData(n),getItemAxis:n=>this._getItemAxis(n)}),this._setupStateListeners(),this._scanDeclarativeElements(),this._options.autoRefresh&&this._setupAutoRefresh(),this._setupScrollResize(),this.enable()}get options(){return this._options}enable(){this._engine.enable()}disable(){this._engine.disable()}destroy(){this._destroyed=!0,this.disable();for(let e of this._stateUnsubscribers)e();this._stateUnsubscribers=[];for(let e of this._plugins)e.destroy();this._plugins=[];for(let e of this._behaviors)e.destroy();this._behaviors=[],this._engine.destroy(),this._state.destroy(),this._dropZoneManager.destroy(),this._observer?.disconnect(),this._observer=null,this._scrollHandler&&(window.removeEventListener("scroll",this._scrollHandler,!0),this._scrollHandler=null),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._imperativeDraggables.clear(),this._imperativeDropZones.clear()}refresh(){this._scanDeclarativeElements(),l.invalidateAll()}addDraggable(e,t){this._imperativeDraggables.set(e,t??{})}removeDraggable(e){this._imperativeDraggables.delete(e)}addDropZone(e,t){this._imperativeDropZones.set(e,t??{}),this._dropZoneManager.register(e,t)}removeDropZone(e){this._imperativeDropZones.delete(e),this._dropZoneManager.unregister(e)}isDragging(){return this._state.isDragging()}getActiveElement(){return this._state.getActiveElement()}use(e){return this._plugins.push(e),e.init(this),this}addBehavior(e){return this._behaviors.push(e),this}setOptions(e){Object.assign(this._options,e),this._engine.updateOptions(this._options)}on(e,t){return this._eventListeners.has(e)||this._eventListeners.set(e,new Set),this._eventListeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this._eventListeners.get(e)?.delete(t)}_emit(e,t){let n=this._eventListeners.get(e);if(n)for(let i of n)i(t)}_wrapCallbacks(){let e={...this._options};this._options.onDragStart=t=>(this._emit("dragstart",t),e.onDragStart?.(t)),this._options.onDragMove=t=>{this._emit("dragmove",t),e.onDragMove?.(t)},this._options.onDragEnd=t=>{this._emit("dragend",t),e.onDragEnd?.(t)},this._options.onDrop=t=>{this._emit("drop",t),e.onDrop?.(t)},this._options.onDropZoneEnter=t=>{this._emit("dropzoneenter",t),e.onDropZoneEnter?.(t)},this._options.onDropZoneLeave=t=>{this._emit("dropzoneleave",t),e.onDropZoneLeave?.(t)}}_getDropZones(){let e=this._options.dropZoneSelector??"[data-droppable]",t=this._container instanceof ShadowRoot?this._container:this._container,n=Array.from(t.querySelectorAll(e)),i=[...this._imperativeDropZones.keys()];return[...new Set([...n,...i])]}_getItemData(e){return this._imperativeDraggables.get(e)?.data}_getItemAxis(e){let t=this._imperativeDraggables.get(e);if(t?.axis)return t.axis;let n=e.dataset.dragAxis;if(n==="x"||n==="y"||n==="both")return n}_scanDeclarativeElements(){let e=this._options.dropZoneSelector??"[data-droppable]",n=(this._container instanceof ShadowRoot?this._container:this._container).querySelectorAll(e);for(let i of n)this._imperativeDropZones.has(i)||this._dropZoneManager.register(i)}_setupStateListeners(){this._stateUnsubscribers.push(this._state.subscribe("dragstart",e=>{for(let t of this._behaviors)t.onDragStart?.(e)})),this._stateUnsubscribers.push(this._state.subscribe("dragmove",e=>{for(let t of this._behaviors)t.onDragMove?.(e)})),this._stateUnsubscribers.push(this._state.subscribe("dragend",e=>{for(let t of this._behaviors)t.onDragEnd?.(e)}))}_setupAutoRefresh(){this._observer=new MutationObserver(t=>{if(this._destroyed)return;let n=!1;for(let i of t)if(i.type==="childList"){n=!0;break}n&&!this._refreshScheduled&&(this._refreshScheduled=!0,requestAnimationFrame(()=>{this._destroyed||(this._refreshScheduled=!1,this.refresh())}))});let e=this._container instanceof ShadowRoot?this._container:this._container;this._observer.observe(e,{childList:!0,subtree:!0})}_setupScrollResize(){this._scrollHandler=()=>{this._state.isDragging()&&l.invalidateAll()},window.addEventListener("scroll",this._scrollHandler,!0),this._resizeHandler=()=>{l.invalidateAll()},window.addEventListener("resize",this._resizeHandler)}},R=M;export{_ as DragState,P as DropZone,v as DropZoneManager,M as Snap,R as default};
