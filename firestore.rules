rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Collection group rule for menuItems - allows searching across all stalls
    match /{path=**}/menuItems/{itemId} {
      allow read: if true;
    }
    // Allow authenticated users to read/write their own orders
    // Customers can read their own orders, vendors can read orders for their stall
    match /orders/{orderId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
    }

    // Allow authenticated users to manage their own cart
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow reading menu items and stalls publicly
    match /stalls/{stallId} {
      allow read: if true;
      allow write: if request.auth != null;

      // Menu items subcollection under stalls
      match /menuItems/{itemId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // foodStalls collection (used by foodStalls.js service)
    match /foodStalls/{stallId} {
      allow read: if true;
      allow write: if request.auth != null;

      // Menu items subcollection
      match /menuItems/{itemId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    match /menuItems/{itemId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Customers subcollections (favourites, feedback, etc.)
    match /customers/{customerId}/{subcollection=**} {
      allow read, write: if request.auth != null && request.auth.uid == customerId;
    }

    // Feedback collection (for vendors to read)
    match /feedback/{feedbackId} {
      allow read: if true;
      allow create: if request.auth != null;
    }

    match /hawkerCentres/{centreId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // User profiles
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Customers collection
    match /customers/{customerId} {
      allow read, write: if request.auth != null && request.auth.uid == customerId;
    }

    // Stall Owners collection (legacy)
    match /stallOwners/{ownerId} {
      allow read, write: if request.auth != null && request.auth.uid == ownerId;
    }

    // Vendors collection
    match /vendors/{vendorId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == vendorId;

      // Vendor subcollections (notifications, etc.)
      match /{subcollection=**} {
        allow read, write: if request.auth != null && request.auth.uid == vendorId;
      }
    }

    // Operators collection
    match /operators/{operatorId} {
      allow read, write: if request.auth != null && request.auth.uid == operatorId;

      // Operator subcollections (notifications, etc.)
      match /{subcollection=**} {
        allow read, write: if request.auth != null && request.auth.uid == operatorId;
      }
    }

    // Onboarding codes for operator-vendor linking
    match /onboardingCodes/{codeId} {
      allow read, write: if request.auth != null;
    }

    // Vouchers collection
    match /vouchers/{voucherId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.vendorId == request.auth.uid;
    }

    // Voucher usage tracking
    match /voucherUsage/{usageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
  }
}
